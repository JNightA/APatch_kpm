name: 构建持续集成

on:
  push:
    paths:
      - ".github/workflows/build-kpm.yml"
      - "**.c"

  workflow_dispatch:
    inputs:
      release:
        description: '发布新版本'
        required: false
        default: 'false'
      version:
        description: '版本号'
        required: false
        default: '2024051900'

jobs:
  在Ubuntu上构建:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TZ: UTC-8

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: 更新系统并安装依赖
        run: |
          sudo apt update -y
          sudo apt install llvm -y

      - name: 构建kpm
        run: |
          mkdir target

          for dir in $(ls -d */ | grep -v '^KernelPatch/$\|^target/$'); do
            make -C ${dir}
            mv ${dir}*.kpm target
          done

      - name: 上传构建产物
        if: success()
        uses: lzghzr/upload-artifact@405e6269d5b1feb22bf2a044deb7950596bed6da
        with:
          path: "target/*.kpm"
          artifact-per-file: true
          artifact-name-rule: ${name}

      - name: 发布版本
        if: github.event.inputs.release == 'true' && success() && !cancelled()
        uses: ncipollo/release-action@v1.14.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: ${{ github.event.inputs.version }}
          tag: ${{ github.event.inputs.version }}
          body: 本版本由GitHub Action自动构建
          artifacts: "target/*.kpm"
          allowUpdates: true
          makeLatest: true
          omitBodyDuringUpdate: true
          replacesArtifacts: true
